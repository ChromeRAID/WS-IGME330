<!DOCTYPE html>
<html lang="en">

	<head>
		<!--Let browser know website is optimized for mobile-->
		<meta name="viewport" content="width=device-width, initial-scale=1.0"
			charset="utf-8" />
		<title>Giphy Finder</title>
		<!-- Vue Import-->
		<script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.js"></script>
		<!--Import Google Icon Font-->
		<link href="https://fonts.googleapis.com/icon?family=Material+Icons"
			rel="stylesheet">
		<!--Import materialize.css-->
		<link type="text/css" rel="stylesheet" href="css/materialize.min.css"
			media="screen,projection" />
	</head>


	<body>

		<div class="row">

			<div class="col s5">
				<h2>Train Model</h2>
				<form action="#">
					<p>
						<label>
							<input type="checkbox" class="filled-in"
								checked="checked" />

							<span>Option1</span>
						</label>
					</p>
					<p>
						<label>
							<input type="checkbox" class="filled-in"
								checked="checked" />

							<span>Option2</span>
						</label>
					</p>
					<p>
						<label>
							<input type="checkbox" class="filled-in"
								checked="checked" />

							<span>Option 3</span>
						</label>
					</p>
					<p>
						<label>
							<input type="checkbox" class="filled-in"
								checked="checked" />
							<span>Option 4</span>
						</label>
					</p>
				</form>
				<button class="btn waves-effect waves-light" type="submit"
					name="action">Submit
					<i class="material-icons right">send</i>
				</button>
			</div>

			<div class="col s5">
				<div id='root'>
				<subredditTemplate name="dogs"></subredditTemplate>
					<h1>{{guess}}</h1>
					<div id="console">
						<img class="responsive-img" id="img" v-bind:src="image"
							crossorgin="Anonymous" width="500" height="500" />
					</div>
					<div class="input-field col s12">
						<p id="output"></p>
						<p><input class="btn waves-effect waves-light"
								id="input" type="file"
								accept='image/jpeg, image/png' size="50"
								maxlength="50" autofocus
								value="Upload image here" /></p>
						<select class="browser-default"
							onchange="selectChange(this)"
							v-model:value="selected">
							<!--<option v-for="item in options"
								v-bind:value="item.value">{{item.text}}</option>-->
						</select>
						<span>Selected: {{ selected }}<br></span>
						<button class="btn waves-effect waves-light"
							type="submit" @click='create'>Create</button>
						<button class="btn waves-effect waves-light"
							type="submit" @click='run'>Run</button>
						<button class="btn waves-effect waves-light"
							type="submit" @click='predictImage'>Predict</button>
						<!--<p v-bind:disabled="isLoading == false">
							<div class="progress">
								<div class="indeterminate"></div>
							</div>
						</p>-->
						<p id="output">{{loadingMessage}}</p>
					</div>
				</div>
			</div>
		</div>
		<canvas id="mainCanvas" width=128 height=128 style="display:none">

		</canvas>




		<script>
			let urls = "https://api.imgur.com/3/gallery/r/";
let status = {
    isFinished: 1,
    message: ""
};
let dataDict = {};
let activeModel;





function loadImages(){
	for(let i = 0; i<app.subreddits.length; i++){
		console.log(urls+app.subreddits[i]);
		XHRRequest(urls+app.subreddits[i],dataLoaded,dataError);
	}
}

function XHRRequest(url,load,error){
    let xhrC = new XMLHttpRequest();
    //Set onload Handler
    xhrC.onload = load;

    //Set the onerror handler
    xhrC.onerror = error;

    //Open connection and set the request
    xhrC.open("GET", url);
    xhrC.setRequestHeader("Authorization", "Client-ID 1226bd29241e849");
    xhrC.send();

}

function dataError(e) {
    console.log("ERROR LOADING DATA");
    console.log("ABORTING...");
    console.log("ABORTED");
}

function dataLoaded(e) {
	if(e.target.status != "200"){
		let tag = e.target.responseURL.split("/")[6];
		app.subreddits = app.subreddits.filter(function(value,index, arr){
			return value!=tag;
		});
		return;
	}
    let label = e.target.responseURL.split("/")[6];
    let JSONObj = JSON.parse(e.target.responseText);
	if(JSONObj.data.length == 0){
		let tag = e.target.responseURL.split("/")[6];
		app.subreddits = app.subreddits.filter(function(value,index, arr){
			return value!=tag;
		});
		return;
	}
    let array = JSONObj.data;
    for (let i = 0; i < array.length; i++) {
        let imageUrl = array[i].link;
        let image = new Image();
        image.crossOrigin = "Anonymous";
        image.src = imageUrl;
        image.onload = getDataImages;
        image.class = label;
    }
}

function getDataImages(e) {

    //app.isLoading = false;
    app.loadingMessage = "Loading images please wait...";
    let canvas = document.createElement("canvas");
    let image = e.path[0];
    canvas.width = 64;
    canvas.height = 64;
    let ctx = canvas.getContext("2d");
    ctx.drawImage(image,0,0,64,64);
    let data = ctx.getImageData(0,0,64,64);
    if(dataDict[image.class] == undefined){
        dataDict[image.class] = [];
    }
    dataDict[image.class].push(data);
}

async function createModel(){
    let layers = [];
    layers.push(tf.layers.conv2d({filters:8, kernelSize:5,padding:'same',activation:'relu',inputShape:[64,64,3]}));
	layers.push(tf.layers.maxPooling2d({poolSize:2}));
	layers.push(tf.layers.conv2d({filters:16, kernelSize:3,padding:'same',activation:'relu'}));
	layers.push(tf.layers.maxPooling2d({poolSize:2}));
	layers.push(tf.layers.flatten());
	layers.push(tf.layers.dense({units:64, activation:'relu'}));
    layers.push(tf.layers.dense({units:1,  activation:'sigmoid'}));
    model.compile({loss: 'meanSquaredError', optimizer: 'adam', metrics: ['accuracy']});
    app.loadingMessage = "Training please wait...";
	await createVisual();
	
    let inputs = getInput(250);
    
   	await train(model, inputs);


}

//returns a 2d tensor of image data
function getInput(amountToGrab) {
    let inputArray = [];
    let labelArray = [];
    let typesCount = Object.keys(dataDict).length;
    for (let i = 0; i < amountToGrab; i++) {
        let index = Math.floor(typesCount * Math.random());
        let type = Object.keys(dataDict)[index];
        labelArray.push(index);
        let fullArray = dataDict[type];
        index = Math.floor(Math.random() * fullArray.length);

        let data = fullArray[index];
        for(let j = 0; j<data.data.length/4; j++){
            inputArray.push(data.data[j]/255);
        	inputArray.push(data.data[j+1]/255);
			inputArray.push(data.data[j+2]/255);
		}
	}
    let inputTensor = tf.tensor4d(inputArray,[amountToGrab,64,64,3]);
    let labelTensor = tf.tensor2d(labelArray,[amountToGrab,1]);
    return [inputTensor,labelTensor];
}

function imagedata_to_image(imagedata) {
    var canvas = document.querySelector('#mainCanvas');
    var ctx = canvas.getContext('2d');
    canvas.width = imagedata.width;
    canvas.height = imagedata.height;
    ctx.putImageData(imagedata, 0, 0);
    app.image = canvas.toDataURL();
}

async function createVisual(){
	let visor = tfvis.visor();
	let modelDisplay = visor.surface({name:"Model Summary", tab:"Model Info"});
	tfvis.show.modelSummary(modelDisplay,model);
}

function SaveModel(){
    //Save stuff to firebase
}

function LoadModel(){
    //Get stuff from firebase   
}

function initModel(){
    activeModel = new ModelClass(app.settings);
}

function CreateModel(){
    let layers = [];
    layers.push(tf.layers.conv2d({filters:8, kernelSize:5,padding:'same',activation:'relu',inputShape:[64,64,3]}));
	layers.push(tf.layers.maxPooling2d({poolSize:2}));
	layers.push(tf.layers.conv2d({filters:16, kernelSize:3,padding:'same',activation:'relu'}));
	layers.push(tf.layers.maxPooling2d({poolSize:2}));
	layers.push(tf.layers.flatten());
	layers.push(tf.layers.dense({units:64, activation:'relu'}));
    layers.push(tf.layers.dense({units:1,  activation:'sigmoid'}));
    let loss = "meanSquaredError";
    let optimizer = "adam";
    let metrics = ["accuracy"];
    activeModel.BuildModel(layers,loss,optimizer,metrics);
}

async function TrainModel(){
    app.loadingMessage = "Training Please Wait...";
    await createVisual();
    let inputs  = getInput(250);
}

function predictTest(){
    let inputArray = [];
        let typesCount  = Object.keys(dataDict).length;
        let index = Math.floor(typesCount*Math.random());
        let type = Object.keys(dataDict)[index];
        let fullArray = dataDict[type];
        index = Math.floor(Math.random()*fullArray.length);
        
        let data = fullArray[index];
    
        imagedata_to_image(data);
    
        for(let j = 0; j<data.data.length/4; j++){
            inputArray.push(data.data[j]/255);
        	inputArray.push(data.data[j+1]/255);
			inputArray.push(data.data[j+2]/255);
		}
        
        let inputTensor = tf.tensor4d(inputArray,[1,64,64,3]);
    
        let prediction = model.predict(inputTensor).asScalar();
        
        
        const a = prediction;
        var array = [];
        array.push(a);

        let values = array.map(t => t.dataSync()[0])
        console.log(values);
    
        let val = values[0];
        let predictType = Object.keys(dataDict)[Math.floor(val*typesCount)];
        console.log(predictType);
		app.guess = `This is a ${predictType}. I'm ${values[0]}% sure. `;
		app.loadingMessage = "";
       	return predictType;
}

		</script>
		<script src="src/vue.js"></script>
		<!-- #1 - link to Firebase goes here  -->
		<script src="https://www.gstatic.com/firebasejs/7.4.0/firebase-app.js"></script>
		<script src="https://www.gstatic.com/firebasejs/7.4.0/firebase-auth.js"></script>
		<script src="https://www.gstatic.com/firebasejs/7.4.0/firebase-database.js"></script>
		<!--Tensorflow-->
		<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@1.0.0/dist/tf.min.js"></script>
		<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs-vis@1.0.2/dist/tfjs-vis.umd.min.js"></script>
		<!--JavaScript at end of body for optimized loading-->
		<script type="text/javascript" src="js/materialize.min.js"></script>

	</body>

</html>